:: Name:     CVE-2017-5715_5753_REG_ADD.cmd
:: Purpose:  Enable Spectre Variant 2 mitigations
:: Purpose:  for Intel/AMD/ARM CPU Meltdown and Spectre vulnerabilities
:: contact:  alex.li@telus.com
:: Revision: Jan 12 2018

@ECHO OFF
SETLOCAL ENABLEEXTENSIONS ENABLEDELAYEDEXPANSION
CLS

:FeatureRegCheck
@echo FeatureSettingsOverride registry values checking...
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverride
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverrideMask
IF %errorlevel%==0 (goto RegValReCheck) else (goto FeatureSettingsOverride)

:FeatureSettingsOverride
@echo FeatureSettingsOverride registry values adding...
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverride /t REG_DWORD /d 0 /f
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverrideMask /t REG_DWORD /d 3 /f

:RegValReCheck
@echo FeatureSettingsOverride registry value re-checking...
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverride|FINDSTR /R /C:"FeatureSettingsOverride"
IF %errorlevel%==0 (goto End) else (goto setError)

:setError
@echo FeatureSettingsOverride registry value is failed to add on this server %computername%
@echo Please check %computername%
TIMEOUT /T 10
Endlocal
Exit /b 1

:End
@echo Enabled Spectre Variant 2 mitigations
@echo for Intel/AMD/ARM CPU Meltdown and Spectre vulnerabilities
TIMEOUT /T 10
Endlocal
Exit /b 0


